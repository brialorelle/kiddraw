---
title: "graveyard_justincase"
author: "Bria Long"
date: '2022-09-02'
output: html_document
---


## Figure XX. Changes in part structure by age

```{r}
img_per_category_age <- d_agree_labels %>%
  group_by(category, age_numeric) %>%
  summarize(count_images = length(unique(filename)))  %>%
  mutate(category = factor(category, levels = c("bird", "fish", "rabbit","dog" ,"sheep","tiger" ,"camel" , "bear", "cup","lamp", "hat","bottle", "car", "boat","airplane","train")))

top_parts_emphasis <- part_emphasis_all %>%
  group_by(category, roi_labelName) %>%
  filter(!roi_labelName %in% c('body','head')) %>%
  summarize(avg_emphasis = mean(emphasis), count_drawings = n()) %>%
  group_by(category) %>%
  slice_max(n=5, order_by=count_drawings)

part_emphasis_top_4_plot <- part_emphasis_all %>%
  mutate(diag_feature_annotation = (roi_labelName == diag_feature)) %>%
  right_join(top_parts_emphasis %>% select(category, roi_labelName)) %>%
  group_by(category, age_numeric, roi_labelName, diag_feature_annotation) %>%
  dplyr::summarize(avg_emphasis = mean(emphasis), count_drawings_with_part = n()) %>%
  left_join(img_per_category_age) %>%
  mutate(prop_drawings = count_drawings_with_part / count_images)
  

```

```{r}

```


```{r}

ggplot(data = part_emphasis_top_4_plot, aes(x=age_numeric, y=prop_drawings, col=roi_labelName)) +
  geom_point(aes(size = avg_emphasis, alpha=.2)) +
  scale_size(range = c(0,4)) +
  facet_wrap(~category, nrow=1) +
  theme_few(base_size=12, base_family = "Helvetica") +
  geom_line(stat='smooth',alpha=.2, span=10, aes(group=roi_labelName)) +
  ylab('Proportion drawings with object part') +
  xlab('Age of drawer') +
  theme(legend.position = 'none', aspect.ratio = 1)  +
  ylim(0,1) +
  facet_wrap(~category, nrow=2, scales = 'free_x') +
  ggrepel::geom_label_repel(data =part_emphasis_top_4_plot %>% filter(age_numeric==8), aes(label = roi_labelName), max.overlaps=10, size=2, label.size=.1, box.padding=.1)

ggsave('part_emphasis_by_age.pdf',units = 'in', height = 4, width = 9)

```


## Appendix Figure: Changes in object part structure with 48-way classification
```{r}
part_emphasis_dnn_recognition <- part_emphasis_all %>%  
  mutate(sketch_path = as.factor(str_split_fixed(filename,'.png',2)[,1])) %>%
  left_join(d)  %>%
  filter(!is.na(correct_or_not))
```

```{r}
# A bunch of drawings were ecxluded from dnn classifications for balancing...annoying

# what <- part_emphasis_all %>%  
#   mutate(sketch_path = as.factor(str_split_fixed(filename,'.png',2)[,1])) %>%
#   left_join(d)  %>%
#   filter(is.na(correct_or_not)) %>%
#   ungroup() %>%
#   distinct(filename, category, age_numeric) %>%
#   group_by(category, age_numeric) %>%
#   summarize(num_excluded = n())

```

```{r}
part_emphasis_recognition_binned <-  part_emphasis_dnn_recognition %>%
  ungroup() %>%
  group_by(category) %>% # construct bins WITHIN categories
  mutate(model_correct_bin = ntile(log_odds,4))


```


```{r}
binned_count_recognition_by_sketch <- part_emphasis_recognition_binned %>%
  group_by(category, model_correct_bin) %>%
  summarize(count_images_bin = length(unique(filename)))

part_emphasis_recognition_binned <- part_emphasis_recognition_binned %>%
  left_join(binned_count_recognition_by_sketch)
```

```{r}
# get emphasized parts without recognition
top_parts_emphasis <- part_emphasis_all %>%
  group_by(category, roi_labelName) %>%
  # filter(!roi_labelName %in% c('body','head')) %>%
  summarize(avg_emphasis = mean(emphasis), count_drawings = n()) %>%
  group_by(category) %>%
  slice_max(n=5, order_by=count_drawings)
#
```

```{r}
part_emphasis_top_4_by_model_bin <- part_emphasis_recognition_binned %>%
  right_join(top_parts_emphasis %>% select(category, roi_labelName)) %>%
  group_by(category, model_correct_bin, roi_labelName,count_images_bin) %>%
  dplyr::summarize(avg_emphasis = mean(emphasis), count_drawings_with_part = length(unique(filename))) %>%
  mutate(prop_drawings = count_drawings_with_part / count_images_bin)
```


```{r}
# part_names = unique(part_emphasis_top_4_by_model_bin$roi_labelName)
part_emphasis_top_4_by_model_bin <- part_emphasis_top_4_by_model_bin %>%
  # mutate(label = as.factor(roi_labelName), levels =  unique(roi_labelName)) %>%
  mutate(category = factor(category, levels = c("bird", "fish", "rabbit","dog" ,"sheep","tiger" ,"camel" , "bear", "cup","lamp", "hat","bottle", "car", "boat","airplane","train")))
```

```{r}
ggplot(data = part_emphasis_top_4_by_model_bin, aes(x=model_correct_bin, y=prop_drawings, col=roi_labelName)) +
  geom_point(aes(size = avg_emphasis, alpha=.2)) +
  # geom_linerange(aes(ymin = ci_lower, ymax = ci_upper), alpha=.5) +
  facet_wrap(~category, nrow=1) +
  theme_few(base_size=8) +
  # geom_line() +
  geom_line(stat='smooth',alpha=.2, span=10) +
  # stat_smooth(geom="line", alpha=0.3, size=.5, span=10) +
  # geom_smooth(aes(group=roi_labelName), span=10, alpha=.01) +
  # scale_color_viridis(option = 'F', discrete=TRUE) +
  ylab('Proportion drawings with object part') +
  xlab('Binned classifier evidence (VGG-19 classifications)') +
  theme(legend.position = 'none', aspect.ratio = 1)  +
  ylim(0,1) +
  facet_wrap(~category, nrow=2, scales = 'free_x') +
  scale_x_continuous(
    limits=c(.5,4.5),
    breaks=c(1,4),
    labels=c(' Low ',' High ')
        ) +
  ggrepel::geom_label_repel(data =part_emphasis_top_4_by_model_bin %>% filter(model_correct_bin==1), aes(label = roi_labelName), max.overlaps=10, size=2, box.padding=.1, label.padding=.1)

ggsave('part_emphasis_by_model_bin.pdf',units = 'in', height = 3, width = 8)
```

## Figure 3: Misclassified draiwngs by VGG (+ each layer) + CLIP
### Make long form VGG classification data
```{r}
classification_data_long <- all_layer_class %>%
  mutate(correct_or_not = as.logical(correct_or_not)) %>%
  gather(key = 'class', value = 'prob', contains('prob')) %>%
  mutate(class = str_split_fixed(class, '_prob',2)[,1]) 
```

### Make long form clip for misclassified data
```{r}
clip_misclassified_long <- clip_long %>%
  right_join(clip_by_image %>% filter(correct_or_not==FALSE) %>% select(-max_prob, -clip_category))  %>%
  mutate(guessed_category = str_replace(guessed_category,' ','.')) %>% # ice cream = ice.cream %>%
  mutate(category = str_replace(category,' ','.'))
```


### Calculate avg prob by category for misclassified

```{r}
#### For VGG
confusions_by_class_by_layer <- classification_data_long %>%
  mutate(drawn_category = category) %>%
  left_join(animacy_csv) %>%
  ungroup() %>%
  filter(correct_or_not==0) %>%
  mutate(drawn_category = fct_reorder(drawn_category, animacy_size)) %>%
  mutate(class = factor(class, levels = levels(drawn_category))) %>%
  group_by(drawn_category, class, layer) %>%
  dplyr::summarize(mean_prob = mean(prob)) 
```

```{r}
#### For CLIP
clip_confusions_by_class<- clip_misclassified_long %>%
  mutate(drawn_category = as.factor(category)) %>%
  left_join(animacy_csv) %>%
  ungroup() %>%
  mutate(drawn_category = fct_reorder(drawn_category, animacy_size)) %>%
  mutate(guessed_category = factor(guessed_category, levels = levels(drawn_category))) %>%
  group_by(drawn_category, guessed_category,animacy_size) %>%
  dplyr::summarize(mean_prob = mean(prob)) 

```

### Appendix FIgure: Clip confusions by class
```{r}
ggplot(data = clip_confusions_by_class, aes(x=guessed_category, y=drawn_category,fill=mean_prob)) + 
  geom_tile() + 
  theme_few(base_size = 12) +
  theme(legend.position = 'left', axis.text.x = element_text(angle = 90,  
  size = 6, vjust=.5, hjust = 1), axis.text.y = element_text(angle = 0,
  size = 6, hjust = 1)) + 
  coord_fixed() + 
  scale_fill_viridis(option="A", name = 'Classifier probability')  +
  ylab('Drawn category')  +
  xlab('Predicted category')


ggsave('figures/appendix_clip_classifier_confusions.pdf', width = 4, height = 5, units = 'in')
```

### Appendix Figure: VGG confusions by class for each layer
```{r}
ggplot(data = confusions_by_class, aes(x=class, y=drawn_category,fill=mean_prob)) + 
  geom_tile() + 
  theme_few(base_size = 12) +
  theme(legend.position = 'left', axis.text.x = element_text(angle = 90,  
  size = 6, vjust=.5, hjust = 1), axis.text.y = element_text(angle = 0,
  size = 6, hjust = 1)) + 
  coord_fixed() + 
  scale_fill_viridis(option="A", limits=c(0,quantile(confusions_by_class$mean_prob,.998)), name = 'Classifier probability')  +
  ylab('Drawn as') +
  xlab('Confused with') +
  facet_grid(~layer)

# ggsave('figures/classifier_confusions.pdf', width = 4, height = 5, units = 'in')
```



### Calculate whether animacy/size were correct
```{r}
animacy_size_acc_by_age <- classification_data_long %>%
  mutate(drawn_category = category) %>%
  left_join(animacy_csv %>% select(animacy, size, category), by = c("drawn_category" = "category")) %>%
  ungroup() %>%
  rename(drawn_category_animacy = animacy, drawn_category_size = size) %>%
  left_join(animacy_csv %>% select(animacy, size, category),  by = c("class" = "category")) %>%
  rename(class_animacy = animacy, class_size = size) %>%
  group_by(image_name, drawn_category, age_numeric, layer) %>%
  mutate(max_prob = max(prob), top_class = prob==max_prob)  %>%
  filter(top_class==TRUE) %>%
  mutate(animacy_correct = (drawn_category_animacy == class_animacy)) %>%
  mutate(size_correct = (drawn_category_size == class_size)) 
```


```{r}

clip_animacy_size_acc_by_age <- clip_misclassified_long %>%
  mutate(drawn_category = category) %>%
  left_join(animacy_csv %>% select(animacy, size, category), by = c("drawn_category" = "category")) %>%
  ungroup() %>%
  rename(drawn_category_animacy = animacy, drawn_category_size = size) %>%
  left_join(animacy_csv %>% select(animacy, size, category),  by = c("guessed_category" = "category")) %>%
  rename(class_animacy = animacy, class_size = size) %>%
  group_by(session_id, drawn_category, kid_age) %>%
  mutate(max_prob = max(prob), top_class = prob==max_prob)  %>%
  filter(top_class==TRUE) %>%
  mutate(animacy_correct = (drawn_category_animacy == class_animacy)) %>%
  mutate(size_correct = (drawn_category_size == class_size)) 

```

### Calculate animacy correct relative to basline
```{r}
baseline_animacy <- mean(animacy_csv$animacy)
baseline_objects <- 1 - mean(animacy_csv$animacy)
```

```{r}
## for vgg
anim_cor_by_category_by_age <- animacy_size_acc_by_age %>%
  filter(correct_or_not==0) %>%
  mutate(drawn_category_animacy = as.factor(drawn_category_animacy))  %>%
  mutate(baseline_chance = case_when(drawn_category_animacy == 0 ~ baseline_objects, 
                                     drawn_category_animacy == 1 ~ baseline_animacy)) %>%
  group_by(age_numeric, drawn_category, layer) %>%
  dplyr::summarize(avg_animacy_correct = mean(animacy_correct) - baseline_chance) %>%
  distinct(age_numeric, avg_animacy_correct, drawn_category)
  
anim_cor_by_age <- anim_cor_by_category_by_age %>%
  group_by(age_numeric, layer) %>%
  multi_boot_standard(col = 'avg_animacy_correct')

```


```{r}
## for clip
clip_anim_cor_by_category_by_age <- clip_animacy_size_acc_by_age %>%
  rename(age_numeric = kid_age) %>%
  filter(correct_or_not==0) %>%
  mutate(drawn_category_animacy = as.factor(drawn_category_animacy))  %>%
  mutate(baseline_chance = case_when(drawn_category_animacy == 0 ~ baseline_objects, 
                                     drawn_category_animacy == 1 ~ baseline_animacy)) %>%
  group_by(age_numeric, drawn_category) %>%
  dplyr::summarize(avg_animacy_correct = mean(animacy_correct) - baseline_chance) %>%
  distinct(age_numeric, avg_animacy_correct, drawn_category)
  
clip_anim_cor_by_age <- clip_anim_cor_by_category_by_age %>%
  group_by(age_numeric) %>%
  multi_boot_standard(col = 'avg_animacy_correct')

```



### Figure 3B: Plot animacy correct by age
```{r}
ggplot(anim_cor_by_age, aes(x=age_numeric,y=mean, color=age_numeric)) +
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper), alpha=.8, size=.2) + 
  geom_point(data=anim_cor_by_category_by_age, aes(x=age_numeric, y=avg_animacy_correct), alpha=.1, size=.5) +
  theme_few(base_size = 8) + 
  labs(x='Age', y='Prop. animacy correct') +
  theme(legend.position = "none") +
  geom_smooth(span=20, alpha=smooth_alpha, color='grey') +
  scale_color_viridis(option="D", discrete=FALSE) +
  geom_hline(yintercept =  0 , linetype="dashed", color="grey")  +
  facet_grid(~layer)


ggsave('figures/animacy_classification.pdf', width = 1.5, height = 1.5, units = 'in')


```

```{r}
objects_only <- animacy_csv %>%
  filter(animacy==0)

baseline_big <- mean(objects_only$size)
baseline_small <- 1 - mean(objects_only$size)

size_cor_by_category_by_age <- animacy_size_acc_by_age %>%
  filter(correct_or_not==0) %>%
  filter(drawn_category_animacy==0) %>% #only objects
  mutate(drawn_category_size = as.factor(drawn_category_size))  %>%
  mutate(baseline_chance = case_when(drawn_category_size == 0 ~ baseline_small, 
                                     drawn_category_size == 1 ~ baseline_big)) %>%
  group_by(age_numeric, drawn_category, layer) %>%
  dplyr::summarize(avg_size_correct = mean(size_correct) - baseline_chance) %>%
  distinct(age_numeric, avg_size_correct, drawn_category)

size_cor_by_age <- size_cor_by_category_by_age %>%
  group_by(age_numeric, layer) %>%
  multi_boot_standard(col = 'avg_size_correct')

```

```{r}
ggplot(clip_size_cor_by_age, aes(x=age_numeric,y=mean, color=age_numeric)) +
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper), alpha=.8, size=.2) + 
  geom_point(data=clip_size_cor_by_category_by_age, aes(x=layer, y=avg_size_correct), alpha=.1, size=.5) +
  theme_few(base_size = 8) + 
  labs(x='Age', y='Prop. object size correct') +
  theme(legend.position = "none") +
  # geom_smooth(span=10, alpha=smooth_alpha, color='grey') +
  # scale_color_viridis(option="D", discrete=FALSE) +
  geom_hline(yintercept =  0 , linetype="dashed", color="grey")  
```

```{r}
ggplot(clip_anim_cor_by_age, aes(x=age_numeric,y=mean, color=age_numeric)) +
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper), alpha=.8, size=.2) + 
  geom_point(data=clip_anim_cor_by_category_by_age, aes(x=age_numeric, y=avg_animacy_correct), alpha=.1, size=.5) +
  theme_few(base_size = 8) + 
  theme(aspect.ratio=1) +
  labs(x='Age', y='Clip prop animacy correct') +
  theme(legend.position = "none") +
  geom_smooth(span=10, alpha=.3, color='grey') +
  scale_color_viridis(option="D", discrete=FALSE) +
  geom_hline(yintercept =  0 , linetype="dashed", color="grey")  

```

### Figure Anim and Size correct by age by each vgg layer
```{r}
ggplot(anim_cor_by_age, aes(x=layer,y=mean, color=age_numeric)) +
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper), alpha=.8, size=.2) + 
  geom_point(data=size_cor_by_category_by_age, aes(x=layer, y=avg_size_correct), alpha=.1, size=.5) +
  theme_few(base_size = 8) + 
  labs(x='Age', y='Prop. object size correct') +
  theme(legend.position = "none") +
  # geom_smooth(span=10, alpha=smooth_alpha, color='grey') +
  # scale_color_viridis(option="D", discrete=FALSE) +
  geom_hline(yintercept =  0 , linetype="dashed", color="grey")  +
  facet_grid(~age_numeric)

ggplot(size_cor_by_age, aes(x=layer,y=mean, color=age_numeric)) +
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper), alpha=.8, size=.2) + 
  geom_point(data=size_cor_by_category_by_age, aes(x=layer, y=avg_size_correct), alpha=.1, size=.5) +
  theme_few(base_size = 8) + 
  labs(x='Age', y='Prop. object size correct') +
  theme(legend.position = "none") +
  # geom_smooth(span=10, alpha=smooth_alpha, color='grey') +
  # scale_color_viridis(option="D", discrete=FALSE) +
  geom_hline(yintercept =  0 , linetype="dashed", color="grey")  +
  facet_grid(~age_numeric)
```


```{r}

# ggsave('figures/size_classification.pdf', width = 1.5, height = 1.5, units = 'in')
```






# Run inferential statisitics and output
```{r}
# set seed for reproducibility
set.seed(123)
```


## Full model predicting accuracy for all drawings
```{R}
all_covariates_accuracy <- glmer(correct_or_not ~ scale(age_numeric)*scale(drawing_frequency)+scale(avg_tracing_rating) + scale(draw_duration) +
                          scale(mean_intensity) +
                          scale(num_strokes) +
                        (1|session_id) +
                        (1|category),
      data = d, family="binomial",control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e4)))
```

```{R}
no_tracing <- glmer(correct_or_not ~ scale(age_numeric)*scale(drawing_frequency)+ scale(draw_duration) +
                          scale(mean_intensity) +
                          scale(num_strokes) +
                        (1|session_id) +
                        (1|category),
      data = d, family="binomial",control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e4)))
```

```{r}
no_tracing_compare <- glmer(correct_or_not ~ scale(age_numeric)*scale(drawing_frequency)+ scale(draw_duration) +
                          scale(mean_intensity) +
                          scale(num_strokes) +
                        (1|session_id) +
                        (1|category),
      data = d %>% filter(!is.na(avg_tracing_rating)), family="binomial",control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e4)))


tracing_compare <- glmer(correct_or_not ~ scale(age_numeric)*scale(drawing_frequency)+ scale(avg_tracing_rating) + scale(draw_duration) +
                          scale(mean_intensity) +
                          scale(num_strokes) +
                        (1|session_id) +
                        (1|category),
      data = d %>% filter(!is.na(avg_tracing_rating)), family="binomial",control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e4)))
```

```{r}
anova(tracing_compare, no_tracing_compare)
```

# Check multicolinearity
```{r}
# https://easystats.github.io/blog/posts/performance_check_collinearity/#:~:text=Multicollinearity%20%E2%80%9Cis%20a%20phenomenon%20in,as%20non%2Dindependent%20covariates).
library(performance)
check_collinearity(all_covariates_accuracy)
```

### Table 1
```{R}
xtable::xtable(summary(all_covariates_accuracy)$coef, digits=3, caption = "Model coefficients of a GLMM predicting the recognizability of each drawing (i.e. binary classification scores), including randomintercepts for each category and participant.")

```

# Full model predicting log odds for correctly classified drawings
```{r}
correct_subset <- d %>% 
  filter(correct_or_not==1)

all_covariates_log_odds_corr_only <- lmer(log_odds ~ scale(age_numeric)*scale(drawing_frequency) + scale(avg_tracing_rating) + scale(draw_duration) +
                          scale(mean_intensity) +
                          scale(num_strokes) +
                        (1|session_id) +
                        (1|category),
      data = correct_subset, control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e4)))

log_odds_out = summary(all_covariates_log_odds_corr_only)$coef

```

Even for drawings that were correctly classified (near 33\% of the balanced subset of drawings, $N$=`r length(unique(correct_subset$filename))`) there was still a reliable increase in the amount of diagnostic information they contained across age, as measured by the log-odds probability assigned by the logistic-regression classifier to the target category (see \textit{Methods}, \textit{B} = `r round(log_odds_out[2,1],3)` , \textit{SE} = `r round(log_odds_out[2,2],3)`, \textit{df} =  `r round(log_odds_out[2,3],3)`, \textit{t} = `r round(log_odds_out[2,4],3)`, \textit{P} < `r round(log_odds_out[2,5],3)`). Thus, this secondary analysis provides additional support for the account that the age-related improvements reflect gradual changes in children's ability to include diagnostic visual features in their drawings (see Figure \ref{fig:drawing_production}B).  

